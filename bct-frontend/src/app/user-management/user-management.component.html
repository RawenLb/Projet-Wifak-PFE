<div class="dashboard-container">
  <!-- ============================================ -->
  <!-- SIDEBAR -->
  <!-- ============================================ -->
  <aside class="sidebar" [class.collapsed]="sidebarCollapsed">
    <!-- Logo Section -->
    <div class="logo-section">
      <div class="logo">
        <div class="logo-icon">ğŸ›ï¸</div>
        <div class="logo-text">
          <div class="bank-name">WIFAK BANK</div>
          <div class="bank-subtitle">Admin Portal</div>
        </div>
      </div>
      <button class="toggle-btn" (click)="toggleSidebar()">â˜°</button>
    </div>

    <!-- Navigation Menu -->
    <nav class="nav-menu">
      <a class="nav-item" [routerLink]="['/dashboard']">
        <span class="nav-icon">ğŸ“Š</span>
        <span class="nav-text">Dashboard</span>
      </a>

      <a class="nav-item active">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-text">Utilisateurs</span>
      </a>

      <a class="nav-item" [routerLink]="['/declarations']">
        <span class="nav-icon">ğŸ“„</span>
        <span class="nav-text">DÃ©clarations</span>
      </a>

      <a class="nav-item" [routerLink]="['/settings']">
        <span class="nav-icon">âš™ï¸</span>
        <span class="nav-text">ParamÃ¨tres</span>
      </a>
    </nav>

    <!-- User Section -->
    
  </aside>

  <!-- ============================================ -->
  <!-- MAIN CONTENT -->
  <!-- ============================================ -->
  <div class="main-content">
    <!-- TOP HEADER -->
    <header class="top-header">
      <div class="header-top">
        <div class="page-title-section">
          <h1>
            <span class="title-icon">ğŸ‘¥</span>
            Gestion des Utilisateurs
          </h1>
          <p class="subtitle">Administration des comptes et des rÃ´les</p>
        </div>

        <button (click)="openCreateModal()" class="btn-create">
          â• CrÃ©er un utilisateur
        </button>
      </div>

      <!-- Search Section -->
      <div class="search-bar">
  <span class="search-icon">ğŸ”</span>

  <input
    type="text"
    placeholder="Rechercher par nom, email ou rÃ´leâ€¦"
    [(ngModel)]="searchQuery"
    (keyup.enter)="searchUsers()"
  />

  <button class="btn-icon" (click)="searchUsers()">â†µ</button>
  <button class="btn-icon clear" *ngIf="searchQuery" (click)="clearSearch()">âœ•</button>
</div>

    </header>

    <!-- CONTENT AREA -->
    <div class="content-area">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card stat-primary">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-info">
            <div class="stat-label">Total Utilisateurs</div>
            <div class="stat-value">{{ users.length }}</div>
          </div>
        </div>

        <div class="stat-card stat-success">
          <div class="stat-icon">âœ…</div>
          <div class="stat-info">
            <div class="stat-label">Actifs</div>
            <div class="stat-value">{{ getActiveUsersCount() }}</div>
          </div>
        </div>

        <div class="stat-card stat-warning">
          <div class="stat-icon">ğŸ”´</div>
          <div class="stat-info">
            <div class="stat-label">Inactifs</div>
            <div class="stat-value">{{ getInactiveUsersCount() }}</div>
          </div>
        </div>

        <div class="stat-card stat-info">
          <div class="stat-icon">âœ‰ï¸</div>
          <div class="stat-info">
            <div class="stat-label">Emails VÃ©rifiÃ©s</div>
            <div class="stat-value">{{ getVerifiedEmailsCount() }}</div>
          </div>
        </div>
      </div>

      <!-- LOADING SPINNER -->
      <div *ngIf="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p>Chargement...</p>
      </div>

      <!-- USERS TABLE -->
      <div class="table-card" *ngIf="!loading">
        <table class="users-table">
          <thead>
            <tr>
              <th>
                <div class="th-content">
                  <span>UTILISATEUR</span>
                </div>
              </th>
              <th>
                <div class="th-content">
                  <span>EMAIL</span>
                </div>
              </th>
              <th>
                <div class="th-content">
                  <span>RÃ”LES</span>
                </div>
              </th>
              <th>
                <div class="th-content">
                  <span>STATUT</span>
                </div>
              </th>
              <th>
                <div class="th-content">
                  <span>CRÃ‰Ã‰ LE</span>
                </div>
              </th>
              <th>
                <div class="th-content">
                  <span>ACTIONS</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users" [class.disabled-row]="!user.enabled">
              <!-- Username -->
              <td>
                <div class="user-cell">
                  
                  <div class="user-details">
                    <div class="username">{{ user.username }}</div>
                    <div class="fullname">{{ user.firstName }} {{ user.lastName }}</div>
                  </div>
                </div>
              </td>

              <!-- Email -->
              <td>
                <div class="email-cell">
                  <div class="email">{{ user.email }}</div>
                  <span *ngIf="user.emailVerified" class="badge-verified">
                    âœ“ VÃ©rifiÃ©
                  </span>
                </div>
              </td>

              <!-- Roles -->
              <td>
                <div class="roles-cell">
                  <span *ngFor="let role of user.roles" 
                        class="role-badge"
                        [ngClass]="getRoleClass(role)">
                    {{ formatRoleName(role) }}
                  </span>
                  <span *ngIf="!user.roles || user.roles.length === 0" class="no-roles">
                    Aucun rÃ´le
                  </span>
                </div>
              </td>

              <!-- Status -->
              <td>
                <div class="status-cell">
                  <span class="status-badge" 
                        [class.status-active]="user.enabled" 
                        [class.status-inactive]="!user.enabled">
                    {{ user.enabled ? 'âœ… Actif' : 'ğŸ”´ Inactif' }}
                  </span>
                </div>
              </td>

              <!-- Created Date -->
              <td>
                <span *ngIf="user.createdTimestamp">
                  {{ user.createdTimestamp | date:'dd/MM/yyyy' }}
                </span>
                <span *ngIf="!user.createdTimestamp" class="no-roles">-</span>
              </td>

              <!-- Actions -->
              <td>
                <div class="actions-cell">
                  <div class="action-buttons">
                    <button (click)="openRoleModal(user)" 
                            class="btn-action btn-roles" 
                            title="GÃ©rer les rÃ´les">
                      ğŸ­
                    </button>
                    <button (click)="openEditModal(user)" 
                            class="btn-action btn-edit" 
                            title="Modifier">
                      âœï¸
                    </button>
                   
                    <button (click)="resetPassword(user)" 
                            class="btn-action btn-reset" 
                            title="RÃ©initialiser mot de passe">
                      ğŸ”
                    </button>
                    <button (click)="deleteUser(user)" 
                            class="btn-action btn-delete" 
                            title="Supprimer">
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </div>
              </td>
            </tr>

            <!-- Empty State -->
            <tr *ngIf="users.length === 0">
              <td colspan="6" class="empty-state">
                <div class="empty-icon">ğŸ˜•</div>
                <p>Aucun utilisateur trouvÃ©</p>
                <button (click)="loadUsers()" class="btn-refresh">RafraÃ®chir</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-section" *ngIf="users.length > 0 && !loading">
        <div class="pagination-info">
          Affichage de {{ users.length }} utilisateur(s)
        </div>
        <div class="pagination-controls">
          <button class="btn-pagination" [disabled]="currentPage === 1" (click)="previousPage()">
            â† PrÃ©cÃ©dent
          </button>
          <span class="page-number">Page {{ currentPage }}</span>
          <button class="btn-pagination" (click)="nextPage()">
            Suivant â†’
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CREATE USER MODAL -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>â• CrÃ©er un nouvel utilisateur</h2>
        <button class="btn-close" (click)="closeCreateModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Nom d'utilisateur *</label>
          <input type="text" 
                 [(ngModel)]="newUser.username" 
                 placeholder="Ex: jdupont"
                 [class.input-error]="!newUser.username && formSubmitted">
          <span class="error-message" *ngIf="!newUser.username && formSubmitted">
            Ce champ est obligatoire
          </span>
        </div>

        <div class="form-group">
          <label>Email *</label>
          <input type="email" 
                 [(ngModel)]="newUser.email" 
                 placeholder="Ex: jdupont@wifak.tn"
                 [class.input-error]="!newUser.email && formSubmitted">
          <span class="error-message" *ngIf="!newUser.email && formSubmitted">
            Ce champ est obligatoire
          </span>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>PrÃ©nom</label>
            <input type="text" [(ngModel)]="newUser.firstName" placeholder="Jean">
          </div>

          <div class="form-group">
            <label>Nom</label>
            <input type="text" [(ngModel)]="newUser.lastName" placeholder="Dupont">
          </div>
        </div>

        <div class="form-group">
          <label>Mot de passe *</label>
          <div class="password-wrapper">
            <input [type]="showPassword ? 'text' : 'password'" 
                   [(ngModel)]="newUser.password" 
                   placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                   [class.input-error]="!newUser.password && formSubmitted">
            <button type="button" 
                    class="toggle-password" 
                    (click)="showPassword = !showPassword">
              {{ showPassword ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}
            </button>
          </div>
          <span class="error-message" *ngIf="!newUser.password && formSubmitted">
            Ce champ est obligatoire
          </span>
        </div>

        <div class="form-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="enabledCheckbox" [(ngModel)]="newUser.enabled">
            <label for="enabledCheckbox">Compte activÃ©</label>
          </div>
        </div>

        <div class="form-group">
          <label>RÃ´les</label>
          <div class="roles-grid">
            <div *ngFor="let role of availableRoles" 
                 class="role-card"
                 [class.role-assigned]="isRoleSelected(role.name)"
                 (click)="toggleRoleSelection(role.name)">
              <div class="role-icon">
                {{ isRoleSelected(role.name) ? 'âœ…' : 'â•' }}
              </div>
              <div class="role-details">
                <span class="role-name">{{ role.name }}</span>
                <span class="role-description">{{ role.description || 'Aucune description' }}</span>
              </div>
              <div class="role-status-badge">
                {{ isRoleSelected(role.name) ? 'AssignÃ©' : 'Non assignÃ©' }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeCreateModal()" class="btn-secondary">Annuler</button>
        <button (click)="createUser()" class="btn-primary">CrÃ©er</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- EDIT USER MODAL -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>âœï¸ Modifier l'utilisateur</h2>
        <button class="btn-close" (click)="closeEditModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Nom d'utilisateur</label>
          <input type="text" [(ngModel)]="editUser.username" disabled>
          <small class="form-hint">Le nom d'utilisateur ne peut pas Ãªtre modifiÃ©</small>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="editUser.email">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>PrÃ©nom</label>
            <input type="text" [(ngModel)]="editUser.firstName">
          </div>

          <div class="form-group">
            <label>Nom</label>
            <input type="text" [(ngModel)]="editUser.lastName">
          </div>
        </div>

        <div class="form-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="editEnabledCheckbox" [(ngModel)]="editUser.enabled">
            <label for="editEnabledCheckbox">Compte activÃ©</label>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeEditModal()" class="btn-secondary">Annuler</button>
        <button (click)="saveUser()" class="btn-primary">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- ROLE MANAGEMENT MODAL -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showRoleModal" (click)="closeRoleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸ­ GÃ©rer les rÃ´les - {{ selectedUser?.username }}</h2>
        <button class="btn-close" (click)="closeRoleModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <p class="info-text">
          Cliquez sur un rÃ´le pour l'ajouter ou le retirer de l'utilisateur
        </p>

        <div class="roles-grid">
          <div *ngFor="let role of availableRoles" 
               class="role-card"
               [class.role-assigned]="hasRole(role.name)"
               (click)="hasRole(role.name) ? removeRole(role.name) : assignRole(role.name)">
            
            <div class="role-icon">
              {{ hasRole(role.name) ? 'âœ…' : 'â•' }}
            </div>
            
            <div class="role-details">
              <span class="role-name">{{ role.name }}</span>
              <span class="role-description">{{ role.description || 'Aucune description' }}</span>
            </div>

            <div class="role-status-badge">
              {{ hasRole(role.name) ? 'AssignÃ©' : 'Non assignÃ©' }}
            </div>
          </div>
        </div>

        <!-- Current Roles Summary -->
        <div class="current-roles-summary">
          <h4>RÃ´les actuels :</h4>
          <div class="roles-list">
            <span *ngFor="let role of userCurrentRoles" class="role-badge">
              {{ role.name }}
            </span>
            <span *ngIf="userCurrentRoles.length === 0" class="no-roles">
              Aucun rÃ´le assignÃ©
            </span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeRoleModal()" class="btn-primary">Fermer</button>
      </div>
    </div>
  </div>
</div>