<div class="dashboard-container">
  <!-- ============================================ -->
  <!-- SIDEBAR -->
  <!-- ============================================ -->
  <aside class="sidebar" [class.collapsed]="sidebarCollapsed">
    <div class="logo-section">
      <div class="logo">
        <div class="logo-icon">
               <div class="logo-icon">üèõÔ∏è</div>
 
        </div>
        <div class="logo-text">
          <div class="bank-name">WIFAK BANK</div>
          <div class="bank-subtitle">Portail d'Administration</div>
        </div>
      </div>
      <button class="toggle-btn" (click)="toggleSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>

    <nav class="nav-menu">
      <a class="nav-item" [routerLink]="['/dashboard']">
        <span class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </span>
        <span class="nav-text">Tableau de bord</span>
      </a>

      <a class="nav-item active">
        <span class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </span>
        <span class="nav-text">Utilisateurs</span>
      </a>

      <a class="nav-item" [routerLink]="['/declarations']">
        <span class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        </span>
        <span class="nav-text">D√©clarations</span>
      </a>

      <a class="nav-item" [routerLink]="['/settings']">
        <span class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m5.2-14.6l-4.2 4.2m0 6l-4.2 4.2m10.4-1.4l-4.2-4.2m-6 0l-4.2-4.2"></path>
          </svg>
        </span>
        <span class="nav-text">Param√®tres</span>
      </a>
    </nav>
 <button class="btn-logout" (click)="logout()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
      <polyline points="16 17 21 12 16 7"/>
      <line x1="21" y1="12" x2="9" y2="12"/>
    </svg>
    Logout
  </button>
    
  </aside>

  <!-- ============================================ -->
  <!-- MAIN CONTENT -->
  <!-- ============================================ -->
  <div class="main-content" [class.sidebar-collapsed]="sidebarCollapsed">
    <!-- TOP HEADER -->
    <header class="top-header">
      <div class="header-content">
        <div class="header-left">
          <div class="breadcrumb">
            <span class="breadcrumb-item">Accueil</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Gestion des Utilisateurs</span>
          </div>
          <h1 class="page-title">Gestion des Utilisateurs</h1>
          <p class="page-subtitle">G√©rez les comptes utilisateurs et leurs permissions</p>
        </div>

        <div class="header-right">
          <button (click)="openCreateModal()" class="btn-create">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>Nouvel utilisateur</span>
          </button>
         
        </div>
      </div>

      <!-- Search Bar -->
      <div class="search-section">
        <div class="search-bar">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input
            type="text"
            placeholder="Rechercher par nom, email ou r√¥le..."
            [(ngModel)]="searchQuery"
            (keyup.enter)="searchUsers()"
          />
          <button class="btn-search" (click)="searchUsers()" *ngIf="searchQuery">
            Rechercher
          </button>
          <button class="btn-clear" *ngIf="searchQuery" (click)="clearSearch()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- CONTENT AREA -->
    <div class="content-area">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card stat-primary">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div class="stat-info">
            <div class="stat-label">Total Utilisateurs</div>
            <div class="stat-value">{{ users.length }}</div>
          </div>
        </div>

        <div class="stat-card stat-success">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <div class="stat-info">
            <div class="stat-label">Comptes Actifs</div>
            <div class="stat-value">{{ getActiveUsersCount() }}</div>
          </div>
        </div>

        <div class="stat-card stat-warning">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
          </div>
          <div class="stat-info">
            <div class="stat-label">Comptes Inactifs</div>
            <div class="stat-value">{{ getInactiveUsersCount() }}</div>
          </div>
        </div>

        <div class="stat-card stat-info">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
          </div>
          <div class="stat-info">
            <div class="stat-label">Emails V√©rifi√©s</div>
            <div class="stat-value">{{ getVerifiedEmailsCount() }}</div>
          </div>
        </div>
      </div>

      <!-- LOADING SPINNER -->
      <div *ngIf="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p>Chargement des donn√©es...</p>
      </div>

      <!-- USERS TABLE -->
      <div class="table-card" *ngIf="!loading">
        <table class="users-table">
          <thead>
            <tr>
              <th>UTILISATEUR</th>
              <th>EMAIL</th>
              <th>R√îLES</th>
              <th>STATUT</th>
              <th>DATE DE CR√âATION</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of paginatedUsers" [class.disabled-row]="!user.enabled">
              <!-- Username -->
              <td>
                <div class="user-cell">
                 
                  <div class="user-details">
                    <div class="username">{{ user.username }}</div>
                    <div class="fullname">{{ user.firstName }} {{ user.lastName }}</div>
                  </div>
                </div>
              </td>

              <!-- Email -->
              <td>
                <div class="email-cell">
                  <div class="email">{{ user.email }}</div>
                  <span *ngIf="user.emailVerified" class="badge-verified">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    V√©rifi√©
                  </span>
                </div>
              </td>

              <!-- Roles -->
              <td>
                <div class="roles-cell">
                  <span *ngFor="let role of user.roles" 
                        class="role-badge"
                        [ngClass]="getRoleClass(role)">
                    {{ formatRoleName(role) }}
                  </span>
                  <span *ngIf="!user.roles || user.roles.length === 0" class="no-roles">
                    Aucun r√¥le
                  </span>
                </div>
              </td>

              <!-- Status -->
              <td>
                <span class="status-badge" 
                      [class.status-active]="user.enabled" 
                      [class.status-inactive]="!user.enabled">
                  <span class="status-dot"></span>
                  {{ user.enabled ? 'Actif' : 'Inactif' }}
                </span>
              </td>

              <!-- Created Date -->
              <td>
                <span class="date-text" *ngIf="user.createdTimestamp">
                  {{ user.createdTimestamp | date:'dd/MM/yyyy' }}
                </span>
                <span *ngIf="!user.createdTimestamp" class="no-data">-</span>
              </td>

              <!-- Actions -->
              <td>
                <div class="action-buttons">
                  <button (click)="openRoleModal(user)" 
                          class="btn-action btn-roles" 
                          title="G√©rer les r√¥les">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                  </button>
                  <button (click)="openEditModal(user)" 
                          class="btn-action btn-edit" 
                          title="Modifier">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button (click)="resetPassword(user)" 
                          class="btn-action btn-reset" 
                          title="R√©initialiser mot de passe">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                  </button>
                  <button (click)="deleteUser(user)" 
                          class="btn-action btn-delete" 
                          title="Supprimer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>

            <!-- Empty State -->
            <tr *ngIf="users.length === 0">
              <td colspan="6" class="empty-state">
                <div class="empty-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                  </svg>
                </div>
                <p class="empty-message">Aucun utilisateur trouv√©</p>
                <button (click)="loadUsers()" class="btn-refresh">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                  </svg>
                  Rafra√Æchir
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination-section" *ngIf="users.length > 0 && !loading">
  <div class="pagination-info">
    Page {{ currentPage }} / {{ totalPages }}
  </div>

  <div class="pagination-controls">
    <button class="btn-pagination"
            [disabled]="currentPage === 1"
            (click)="previousPage()">
      ‚óÄ Pr√©c√©dent
    </button>

    <button class="btn-pagination"
            [disabled]="currentPage === totalPages"
            (click)="nextPage()">
      Suivant ‚ñ∂
    </button>
  </div>
</div>

    </div>
  </div>

  <!-- ============================================ -->
  <!-- CREATE USER MODAL -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚ûï Cr√©er un nouvel utilisateur</h2>
        <button class="btn-close" (click)="closeCreateModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Nom d'utilisateur *</label>
          <input type="text" 
                 [(ngModel)]="newUser.username" 
                 placeholder="Ex: jdupont"
                 [class.input-error]="!newUser.username && formSubmitted">
          <span class="error-message" *ngIf="!newUser.username && formSubmitted">
            Ce champ est obligatoire
          </span>
        </div>

        <div class="form-group">
          <label>Email *</label>
          <input type="email" 
                 [(ngModel)]="newUser.email" 
                 placeholder="Ex: jdupont@wifak.tn"
                 [class.input-error]="!newUser.email && formSubmitted">
          <span class="error-message" *ngIf="!newUser.email && formSubmitted">
            Ce champ est obligatoire
          </span>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Pr√©nom</label>
            <input type="text" [(ngModel)]="newUser.firstName" placeholder="Jean">
          </div>

          <div class="form-group">
            <label>Nom</label>
            <input type="text" [(ngModel)]="newUser.lastName" placeholder="Dupont">
          </div>
        </div>

        <div class="form-group">
          <label>Mot de passe *</label>
          <div class="password-wrapper">
            <input [type]="showPassword ? 'text' : 'password'" 
                   [(ngModel)]="newUser.password" 
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   [class.input-error]="!newUser.password && formSubmitted">
            <button type="button" 
                    class="toggle-password" 
                    (click)="showPassword = !showPassword">
              {{ showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}
            </button>
          </div>
          <span class="error-message" *ngIf="!newUser.password && formSubmitted">
            Ce champ est obligatoire
          </span>
        </div>

        <div class="form-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="enabledCheckbox" [(ngModel)]="newUser.enabled">
            <label for="enabledCheckbox">Compte activ√©</label>
          </div>
        </div>

        <div class="form-group">
          <label>R√¥les</label>
          <div class="roles-grid">
            <div *ngFor="let role of availableRoles" 
                 class="role-card"
                 [class.role-assigned]="isRoleSelected(role.name)"
                 (click)="toggleRoleSelection(role.name)">
              <div class="role-icon">
                {{ isRoleSelected(role.name) ? '‚úÖ' : '‚ûï' }}
              </div>
              <div class="role-details">
                <span class="role-name">{{ role.name }}</span>
                <span class="role-description">{{ role.description || 'Aucune description' }}</span>
              </div>
              <div class="role-status-badge">
                {{ isRoleSelected(role.name) ? 'Assign√©' : 'Non assign√©' }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeCreateModal()" class="btn-secondary">Annuler</button>
        <button (click)="createUser()" class="btn-primary">Cr√©er</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- EDIT USER MODAL -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚úèÔ∏è Modifier l'utilisateur</h2>
        <button class="btn-close" (click)="closeEditModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Nom d'utilisateur</label>
          <input type="text" [(ngModel)]="editUser.username" disabled>
          <small class="form-hint">Le nom d'utilisateur ne peut pas √™tre modifi√©</small>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="editUser.email">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Pr√©nom</label>
            <input type="text" [(ngModel)]="editUser.firstName">
          </div>

          <div class="form-group">
            <label>Nom</label>
            <input type="text" [(ngModel)]="editUser.lastName">
          </div>
        </div>

        <div class="form-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="editEnabledCheckbox" [(ngModel)]="editUser.enabled">
            <label for="editEnabledCheckbox">Compte activ√©</label>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeEditModal()" class="btn-secondary">Annuler</button>
        <button (click)="saveUser()" class="btn-primary">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- ROLE MANAGEMENT MODAL -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showRoleModal" (click)="closeRoleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üé≠ G√©rer les r√¥les - {{ selectedUser?.username }}</h2>
        <button class="btn-close" (click)="closeRoleModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <p class="info-text">
          Cliquez sur un r√¥le pour l'ajouter ou le retirer de l'utilisateur
        </p>

        <div class="roles-grid">
          <div *ngFor="let role of availableRoles" 
               class="role-card"
               [class.role-assigned]="hasRole(role.name)"
               (click)="hasRole(role.name) ? removeRole(role.name) : assignRole(role.name)">
            
            <div class="role-icon">
              {{ hasRole(role.name) ? '‚úÖ' : '‚ûï' }}
            </div>
            
            <div class="role-details">
              <span class="role-name">{{ role.name }}</span>
              <span class="role-description">{{ role.description || 'Aucune description' }}</span>
            </div>

            <div class="role-status-badge">
              {{ hasRole(role.name) ? 'Assign√©' : 'Non assign√©' }}
            </div>
          </div>
        </div>

        <!-- Current Roles Summary -->
        <div class="current-roles-summary">
          <h4>R√¥les actuels :</h4>
          <div class="roles-list">
            <span *ngFor="let role of userCurrentRoles" class="role-badge">
              {{ role.name }}
            </span>
            <span *ngIf="userCurrentRoles.length === 0" class="no-roles">
              Aucun r√¥le assign√©
            </span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeRoleModal()" class="btn-primary">Fermer</button>
      </div>
    </div>
  </div>
</div>